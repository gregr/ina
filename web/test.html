<!DOCTYPE html>
<style>
.hframe {
  display: table-cell;
  border: 1px solid;
}
.vframe {
  display: table-row;
  border: 1px solid #000000;
}
.chassis {
  display: inline-block;
  vertical-align: top;
  border-collapse: collapse;
  margin: 1px;
  border: 2px solid #336666;
}
.atom {
  cursor: pointer;
  font-family: monospace;
  white-space: pre;
  min-width: 10px;
  min-height: 10px;
}
.boolean {
  background-color: #00ff00;
}
.number {
  background-color: #ff9900;
}
.text {
  background-color: #00ffff;
}
</style>
<div id="target"></div>
<button id="add">add</button>
<input id="key"></input>
<button id="remove">remove</button>
<script src="data.js"></script>
<script src="relation.js"></script>
<script>
'use strict';
function html_boolean(value) {
  return '<span class="atom boolean hframe">' + escape_html(write(value)) + '</span>';
}
function html_number(value) {
  return '<span class="atom number hframe">' + escape_html(write(value)) + '</span>';
}
function html_text(value) {
  return '<span class="atom text hframe">' + escape_html(write(value)) + '</span>';
}
function html_atom(value) {
  if (is_number(value)) { return html_number(value); }
  if (is_text(value)) { return html_text(value); }
  if (is_boolean(value)) { return html_boolean(value); }
  throw [value, 'is not an atom'];
}
function html_array(xs) {
  var atoms = [];
  for (var i = 0, len = xs.length; i < len; ++i) {
    atoms.push(html_atom(xs[i]));
  }
  return '<div class="chassis">' + atoms.join('') + '</div>';
}
function html_btree(bt) {
  if (bt.children) {
    var subs = [];
    var keys = array_insert(bt.keys, 0, '_');
    for (var i = 0, len = bt.children.length; i < len; ++i) {
      subs.push('<div class="chassis hframe"><div class="vframe>"><div class="chassis">'+html_atom(keys[i])+'</div></div>'+html_btree(bt.children[i])+'</div>');
    }
    return '<div class="chassis">' + subs.join('') + '</div>'
  } else { return html_array(bt.keys); }
}
var log = [];
var current_btree = btree_from_list(range(0, 49));
var input_key = document.getElementById('key');
var button_add = document.getElementById('add');
var button_remove = document.getElementById('remove');

function update() { target.innerHTML = html_btree(current_btree); }
function read_value(str) {
  var ss = stream(str);
  var v = read(ss);
  if (v === undefined || read(ss) !== undefined || !stream_finished(ss)) {
    alert('bad value');
    throw 'bad value';
  }
  return v;
}
function input_key_value() {
  return read_value(input_key.value);
}
function add_key() {
  var val = input_key_value();
  current_btree = btree_put(current_btree, val, val);
  log.push(['add', val]);
  update();
}
function remove_key() {
  var val = input_key_value();
  current_btree = btree_remove(current_btree, val);
  log.push(['remove', val]);
  update();
}
function enter_key(e) {
  if (e.type === 'keypress' && e.key !== 'Enter') return;
  add_key();
  if (is_number(input_key_value())) { ++input_key.value; }
}
function remove_selected(e) {
  if (e.target.classList.contains('atom')) {
    var value = e.target.innerHTML;
    if (value === '_') return;
    input_key.value = value;
    remove_key();
  }
}

input_key.addEventListener('keypress', enter_key, true);
button_add.addEventListener('click', add_key, true);
button_remove.addEventListener('click', remove_key, true);

var target = document.getElementById('target');
target.addEventListener('click', remove_selected, false);
update();
</script>
